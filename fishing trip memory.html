<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>OWM API テスト</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #0056b3;
    }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }
    .success {
      color: green;
      font-weight: bold;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .info {
      color: blue;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>OWM API テスト</h1>
    
    <div class="test-section">
      <h2>1. 現在天気 (/data/3.0/onecall)</h2>
      <button onclick="testCurrentWeather()">テスト実行</button>
      <pre id="result1">結果はここに表示されます...</pre>
    </div>

    <div class="test-section">
      <h2>2. 過去天気 (/data/3.0/onecall/timemachine)</h2>
      <button onclick="testHistoricalWeather()">テスト実行</button>
      <pre id="result2">結果はここに表示されます...</pre>
    </div>

    <div class="test-section">
      <h2>3. 旧 API (/data/2.5/weather)</h2>
      <button onclick="testOldWeather()">テスト実行</button>
      <pre id="result3">結果はここに表示されます...</pre>
    </div>

    <div class="test-section">
      <h2>4. Cloudflare Worker プロキシ（現在天気）</h2>
      <button onclick="testWorkerProxy()">テスト実行</button>
      <pre id="result4">結果はここに表示されます...</pre>
    </div>

    <div class="test-section">
      <h2>5. Cloudflare Worker プロキシ（過去天気 - timemachine）</h2>
      <button onclick="testWorkerProxyHistorical()">テスト実行</button>
      <pre id="result5">結果はここに表示されます...</pre>
    </div>
  </div>

  <script>
    // ★ここにAPIキーを記載
    const API_KEY = "be6b5f3d369503a85d9915aa654d9893"; // 実際のキーに置き換え
    const LAT = 34.62;
    const LNG = 135.05;

    async function testCurrentWeather() {
      const result = document.getElementById('result1');
      try {
        result.innerHTML = '<span class="info">テスト中...</span>';
        
        const url = `https://api.openweathermap.org/data/3.0/onecall?lat=${LAT}&lon=${LNG}&appid=${API_KEY}&units=metric&lang=ja`;
        console.log('[Test] Current Weather URL:', url);
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (response.status === 200) {
          result.innerHTML = `<span class="success">✓ 成功 (Status: ${response.status})</span>\n${JSON.stringify(data, null, 2)}`;
        } else {
          result.innerHTML = `<span class="error">✗ エラー (Status: ${response.status})</span>\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="error">✗ 例外エラー</span>\n${error.message}`;
      }
    }

    async function testHistoricalWeather() {
      const result = document.getElementById('result2');
      try {
        result.innerHTML = '<span class="info">テスト中...</span>';
        
        // 2025-11-17 の過去データをテスト
        const dt = Math.floor(new Date('2025-11-17T06:49:10+09:00').getTime() / 1000);
        const url = `https://api.openweathermap.org/data/3.0/onecall/timemachine?lat=${LAT}&lon=${LNG}&dt=${dt}&appid=${API_KEY}&units=metric&lang=ja`;
        console.log('[Test] Historical Weather URL:', url);
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (response.status === 200) {
          result.innerHTML = `<span class="success">✓ 成功 (Status: ${response.status})</span>\n${JSON.stringify(data, null, 2)}`;
        } else {
          result.innerHTML = `<span class="error">✗ エラー (Status: ${response.status})</span>\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="error">✗ 例外エラー</span>\n${error.message}`;
      }
    }

    async function testOldWeather() {
      const result = document.getElementById('result3');
      try {
        result.innerHTML = '<span class="info">テスト中...</span>';
        
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LNG}&appid=${API_KEY}&units=metric&lang=ja`;
        console.log('[Test] Old Weather URL:', url);
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (response.status === 200) {
          result.innerHTML = `<span class="success">✓ 成功 (Status: ${response.status})</span>\n${JSON.stringify(data, null, 2)}`;
        } else {
          result.innerHTML = `<span class="error">✗ エラー (Status: ${response.status})</span>\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="error">✗ 例外エラー</span>\n${error.message}`;
      }
    }

    async function testWorkerProxy() {
      const result = document.getElementById('result4');
      try {
        result.innerHTML = '<span class="info">テスト中...</span>';
        
        const WORKER_URL = 'https://noisy-grass-c7e9.yuji-fallline2999m.workers.dev';
        const requestBody = {
          lat: LAT,
          lng: LNG,
          isHistorical: false
        };
        
        console.log('[Test] Worker Proxy URL:', WORKER_URL);
        console.log('[Test] Request Body:', requestBody);
        
        const response = await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (response.status === 200) {
          result.innerHTML = `<span class="success">✓ 成功 (Status: ${response.status})</span>\n${JSON.stringify(data, null, 2)}`;
        } else {
          result.innerHTML = `<span class="error">✗ エラー (Status: ${response.status})</span>\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="error">✗ 例外エラー</span>\n${error.message}`;
      }
    }

    async function testWorkerProxyHistorical() {
      const result = document.getElementById('result5');
      try {
        result.innerHTML = '<span class="info">テスト中...</span>';
        
        const WORKER_URL = 'https://noisy-grass-c7e9.yuji-fallline2999m.workers.dev';
        // 2025-11-17 06:49:10 JST の過去データをリクエスト
        const dt = Math.floor(new Date('2025-11-17T06:49:10+09:00').getTime() / 1000);
        const requestBody = {
          lat: LAT,
          lng: LNG,
          isHistorical: true,
          dt: dt
        };
        
        console.log('[Test] Worker Proxy URL (Historical):', WORKER_URL);
        console.log('[Test] Request Body:', requestBody);
        console.log('[Test] dt value:', dt);
        
        const response = await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (response.status === 200) {
          result.innerHTML = `<span class="success">✓ 成功 (Status: ${response.status})</span>\n${JSON.stringify(data, null, 2)}`;
        } else {
          result.innerHTML = `<span class="error">✗ エラー (Status: ${response.status})</span>\n${JSON.stringify(data, null, 2)}`;
        }
      } catch (error) {
        result.innerHTML = `<span class="error">✗ 例外エラー</span>\n${error.message}`;
      }
    }

    // ページ読み込み時にコンソールに情報を表示
    console.log('OWM API テストスクリプト起動');
    console.log('APIキー:', API_KEY);
    console.log('座標:', LAT, LNG);
  </script>
</body>
</html>
